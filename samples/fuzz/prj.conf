# ==========================================
# 1. 基础配置 (你的版本 4.3.0 兼容)
# ==========================================
CONFIG_DEBUG=y
CONFIG_ASSERT=y
CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=2
CONFIG_HEAP_MEM_POOL_SIZE=65536
CONFIG_MAIN_STACK_SIZE=4096

# ==========================================
# 2. 内核功能开启 (这些在 4.3.0 中依然有效)
# ==========================================
CONFIG_POLL=y
CONFIG_EVENTS=y
CONFIG_DYNAMIC_INTERRUPTS=y
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y
CONFIG_THREAD_CUSTOM_DATA=y
CONFIG_THREAD_STACK_INFO=y

# 移除 CONFIG_PIPES=y (4.x 已移除)
# 移除 CONFIG_MBOX=y (如果报警告也请移除)

# ==========================================
# 3. 运行环境配置
# ==========================================
CONFIG_USERSPACE=n
CONFIG_FPU=n
CONFIG_CBPRINTF_FP_SUPPORT=y

CONFIG_IDLE_STACK_SIZE=2048

# 增加中断栈 (防止 printk 在中断中溢出)
CONFIG_ISR_STACK_SIZE=4096





CONFIG_ASSERT_LEVEL=2

# 关掉之前的堆检查，防止干扰，我们靠 Assert 抓逻辑错误

CONFIG_SYS_HEAP_VALIDATE=y

CONFIG_SYS_HEAP_INFO=y

# 开启硬件 MPU 栈保护：如果栈溢出，会立刻报 Stack Fail，而不是 PC=0
# CONFIG_HW_STACK_PROTECTION=y
# CONFIG_STACK_SENTINEL=n

# 调大主栈：给 Fuzz 留出足够的呼吸空间
# CONFIG_MAIN_STACK_SIZE=4096

# 调试与符号保留

# ==========================================
# 4. 最小诊断增强（定位内存/栈破坏）
# ==========================================

# ARM Cortex-M fault 信息打印等级（0=关，1=简略，2=详细）
CONFIG_FAULT_DUMP=2

# 初始化线程栈内容（便于更早暴露未初始化/越界类问题；也给栈分析提供基础）
CONFIG_INIT_STACKS=y

# 栈保护（Cortex-M3 无 SPLIM，通常走 MPU stack guard 路线）
# 注意：若开启了 MPU_STACK_GUARD，就不能再启用 STACK_SENTINEL（两者互斥）
CONFIG_ARM_MPU=y
# CONFIG_MPU_STACK_GUARD=y

CONFIG_STACK_SENTINEL=y 

CONFIG_STACK_CANARIES_STRONG=y

# === 实验配置：大栈 + 无保护 ===
CONFIG_HW_STACK_PROTECTION=n  # 关掉保护
# CONFIG_STACK_SENTINEL=n       # 关掉哨兵

# 保持巨大的栈
CONFIG_ISR_STACK_SIZE=4096
# CONFIG_MAIN_STACK_SIZE=16384
# CONFIG_IDLE_STACK_SIZE=8192