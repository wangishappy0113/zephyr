# ==========================================
# 1. 基础调试配置
# ==========================================
CONFIG_DEBUG=y
CONFIG_ASSERT=y

# 优化等级调整：为了获得最准确的栈回溯，建议开启调试优化
CONFIG_DEBUG_OPTIMIZATIONS=y

# ==========================================
# 2. 日志系统 (关键：防止死机时日志丢失)
# ==========================================
CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=2
CONFIG_PRINTK=y

# [关键] 立即输出模式：确保 Crash 瞬间的日志能被 QEMU/LibAFL 捕获
CONFIG_LOG_MODE_IMMEDIATE=n
# (可选) 如果是 USB 控制台可能需要等待，但 QEMU UART 不需要

# ==========================================
# 3. 栈与内存 (不仅要大，还要巨大)
# ==========================================
# [终极修复] ISR 栈：处理 HardFault + CoreDump 需要巨大空间
# 16384 (16KB) 能够绝对保证 Fault Handler 不会因为栈溢出而 Lockup
CONFIG_ISR_STACK_SIZE=16384
CONFIG_MAIN_STACK_SIZE=8192
CONFIG_IDLE_STACK_SIZE=2048

# [必须] 硬件栈保护与哨兵
CONFIG_HW_STACK_PROTECTION=n
CONFIG_STACK_SENTINEL=n
# 开启栈指针验证 (如果架构支持)

# ==========================================
# 4. 堆内存配置 (配合 Harness)
# ==========================================
CONFIG_HEAP_MEM_POOL_SIZE=65536
# 开启堆完整性校验：Alloc/Free 时检查 Canary
CONFIG_SYS_HEAP_VALIDATE=y
# 开启堆详细信息 (可选)
CONFIG_SYS_HEAP_INFO=y

# ==========================================
# 5. 故障诊断与 CoreDump
# ==========================================
# 打印异常时的栈回溯
CONFIG_EXCEPTION_STACK_TRACE=n

# 开启 CoreDump
CONFIG_DEBUG_COREDUMP=n
# [关键] 将 CoreDump 输出到日志后端 (串口)
CONFIG_DEBUG_COREDUMP_BACKEND_LOGGING=y
# 仅转储内存相关的关键区域，防止日志过长 (可选，视需要开启)
# CONFIG_DEBUG_COREDUMP_MEMORY_DUMP_MIN=y

# ==========================================
# 6. 线程监控 (辅助调试)
# ==========================================
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y
CONFIG_THREAD_STACK_INFO=y